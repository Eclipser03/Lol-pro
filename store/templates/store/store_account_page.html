{% extends "user/base.html" %}
{% load static %}
{% block head %}
  <link rel="stylesheet" href="{% static 'css/store_account_page.css' %}">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;700&display=swap" rel="stylesheet">
{% endblock %}
{% block content %}
<div class="container">
  <!-- Left Section: Order Information -->
  <div class="order-info">
    <div class="order-details">
      <h1>üõí –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h1>
      <p><span class="icon">‚úîÔ∏è</span>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞</p>
    </div>

    <!-- Table with order details -->
    <table class="order-table">
      <tr>
        <th>–°–µ—Ä–≤–µ—Ä:</th>
        <td>{{ account.server }}</td>
        <th>–ß–µ–º–ø–∏–æ–Ω—ã:</th>
        <td>{{ account.champions }}</td>
      </tr>
      <tr>
        <th>–£—Ä–æ–≤–µ–Ω—å:</th>
        <td>{{ account.lvl }}</td>
        <th>–†–∞–Ω–≥:</th>
        <td>{{ account.rang }}</td>
      </tr>
      <tr>
        <th>–°–∫–∏–Ω—ã:</th>
        <td>{{ account.skins }}</td>
      </tr>
    </table>

    <!-- Short description -->
    <div class="description">
      <h3>–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:</h3>
      <p>{{ account.short_description }}</p>
    </div>

    <!-- Long description -->
    <div class="long-description">
      <h3>–ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:</h3>
      <p>{{ account.description|linebreaksbr }}</p> <!-- –£–±—Ä–∞–ª–∏ –ª–∏—à–Ω—é—é —Å–∫–æ–±–∫—É -->
    </div>

    <div class="image-gallery">
      {% if account.images %}
        {% for image in account.images.all %}
          <img src="{{ image.image.url }}" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞" class="thumbnail" onclick="openModal('{{ image.image.url }}')">
        {% endfor %}
      {% endif %}
    </div>

      {% if account.is_active %}
      <div class="payment">
        <button type="submit" id="bybtn" class="btn">–ö—É–ø–∏—Ç—å</button>
      </div>
      {% endif %}

  </div>

  <!-- Right Section: Seller Information -->
   {% if chat_room %}
  <div class="seller-info">
    <div class="info_seller">
      <img src="{{ account.user.avatar.url }}" alt="" class="avatar1">
      <div class="text-block">
        <h2>–ü—Ä–æ–¥–∞–≤–µ—Ü: {{ account.user.username }}</h2>
        <p class="status {% if account.user.is_online %}online{% else %}offline{% endif %}">{% if account.user.is_online %} –û–Ω–ª–∞–π–Ω {% else %} –û—Ñ—Ñ–ª–∞–π–Ω {% endif %}</p>
      </div>
    </div>
    <div class="chat-log">
      {% for sms in chat_room.messages.all %}
      {% if sms.massage_type == 'chat_message'%}
        {% if sms.author == user %}
          <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–≤—ã) -->
          <div class="message_you">
            <p>
              <span class="sender">–í—ã</span>: {{ sms.text }}</p>
              <p><span class="time">{{ sms.created|date:"H:i" }}</span></p>

          </div>
        {% else %}
          <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–æ–¥–∞–≤—Ü–∞) -->
          <div class="message_seller">
            <p>
              <span class="sender">{{ sms.author.username }}</span>: {{ sms.text }}</p>
              <p><span class="time">{{ sms.created|date:"H:i" }}</span></p>

          </div>
        {% endif %}
      {% endif %}
      {% if sms.massage_type == 'buy_account'%}
        {% if sms.author == user %}
        <div class="buy_notification">
          <div class="notification_buyer">
            <p>–í—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–æ–±—Ä–µ–ª–∏ –∞–∫–∫–∞—É–Ω—Ç —É –ø—Ä–æ–¥–∞–≤—Ü–∞ <strong>{{ chat_room.seller.username }}</strong>.</p>
            <p>–û–∂–∏–¥–∞–π—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å –¥–ª—è –≤—Ö–æ–¥–∞.</p>
            {% if not account.is_confirmed %}
              <button class="confirm_purchase" onclick="confirmPurchase()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–∫—É–ø–∫—É</button>
            {% endif %}
          </div>
        </div>
        {% else %}
        <div class="buy_notification">
          <div class="notification_seller">
            <p>–ü–æ–∫—É–ø–∞—Ç–µ–ª—å <strong>{{ chat_room.buyer.username }}</strong> –ø—Ä–∏–æ–±—Ä–µ–ª –≤–∞—à –∞–∫–∫–∞—É–Ω—Ç.</p>
            <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ –µ–º—É –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å –¥–ª—è –≤—Ö–æ–¥–∞.</p>
          </div>
        </div>
        {% endif %}
      {% endif %}
      {% if sms.massage_type == 'buy_account_acept'%}
          {% if sms.author == user %}
          <div class="buy_notification">
            <div class="notification_buyer">
              <p>–í—ã —É—Å–ø–µ—à–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª–∏ –ø–æ–∫—É–ø–∫—É!</p>
            </div>
          </div>
          {% else %}
          <div class="buy_notification">
            <div class="notification_seller">
              <p>–ü–æ–∫—É–ø–∞—Ç–µ–ª—å <strong>{{ chat_room.buyer.username }}</strong> –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –ø–æ–∫—É–ø–∫—É, –≤–∞—à –±–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω.</p>
            </div>
          </div>
          {% endif %}
      {% endif %}
      {% endfor %}
    </div>
    <input type="text" id="chat-message-input" autocomplete="off" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
    <button id="chat-message-submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </div>
  {% else %}
  {% endif %}
</div>

<!-- Modal for viewing large image -->
<div id="imageModal" class="modal">
  <span class="close" onclick="closeModal()">&times;</span>
  <img class="modal-content" id="modalImage">
  <a class="prev" onclick="changeImage(-1)">&#10094;</a>
  <a class="next" onclick="changeImage(1)">&#10095;</a>
</div>


{% endblock %}
{% block scripts %}
<script>
  let chatRoomId = "{{ chat_room.id }}";  // –ü–æ–¥—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π ID
  let accountId = "{{ account.id }}"
  let userId = "{{ request.user }}";   // –ü–æ–¥—Å—Ç–∞–≤–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  const wsUrl = 'ws://' + window.location.host + '/ws/chat/' + chatRoomId + '/' + accountId + '/';
  const byBtn = document.getElementById('bybtn');

  // –°–æ–∑–¥–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ WebSocket
  let chatSocket = new WebSocket(wsUrl);

  chatSocket.onopen = function() {
      console.log('WebSocket connection opened');
  };

  chatSocket.onclose = function(e) {
      console.log('WebSocket connection closed: ', e);
  };

  chatSocket.onerror = function(e) {
      console.log('WebSocket error: ', e);
  };

  chatSocket.onmessage = function(e) {
      const data = JSON.parse(e.data);
      console.log('Message received:', data);

      const type = data.type
    if (type === 'chat_message') {
        const message = data.message;
        const username = data.username;
        const created = data.created;


      const currentUser = "{{ user.username }}";

        console.log('123',data)
        const chatMessages = document.querySelector(".chat-log");
        const messageElement = document.createElement('div');

        if (username === currentUser) {
          messageElement.classList.add("message_you");
          messageElement.innerHTML = `<p><span class="sender">–í—ã</span>: ${message} <span class="time">${created}</span></p>`;
        } else {
          messageElement.classList.add("message_seller");
          messageElement.innerHTML = `<p><span class="sender">${username}</span>: ${message} <span class="time">${created}</span></p>`;
        }

        chatMessages.appendChild(messageElement);
        chatMessages.scrollTop = chatMessages.scrollHeight

  }
   if (type === 'error') {
        const messagesDiv = document.getElementById("messages-container");
        var message = document.createElement('div');
        message.setAttribute('class', 'alert alert-' + "warning");
        message.textContent = data.message
        messagesDiv.appendChild(message)
     // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –∑–∞–¥–∞–µ–º —Ç–∞–π–º–µ—Ä –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è
     messagesDiv.style.display = "block";
     setTimeout(() => {
       messagesDiv.style.opacity = "0"; // –ü–ª–∞–≤–Ω–æ–µ –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ
       setTimeout(() => {
         messagesDiv.style.display = "none";
         messagesDiv.style.opacity = "1"; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –¥–ª—è –±—É–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
       }, 500); // –í—Ä–µ–º—è –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è (–≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö)
     }, 3000);
   }
   if (type === 'buy_account') {
      console.log(data)
      const currentUser = "{{ user.username }}";
      const userId = data.userid
      const seller = "{{ chat_room.seller.username }}";
      const buyer = "{{ chat_room.buyer.username }}";
      const chatMessages = document.querySelector(".chat-log");
      const messageElement = document.createElement('div');
      messageElement.classList.add("buy_notification");
      console.log('1111', currentUser, seller, buyer)

      // –£–¥–∞–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–ö—É–ø–∏—Ç—å", –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
  const buyButton = document.getElementById('bybtn'); // –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ ID –∫–Ω–æ–ø–∫–∏ "–ö—É–ø–∏—Ç—å"
  if (buyButton) {
    buyButton.remove();
  }

      if (currentUser === seller) {
        messageElement.innerHTML = `
        <div class="notification_seller">
          <p>–ü–æ–∫—É–ø–∞—Ç–µ–ª—å <strong>${buyer}</strong> –ø—Ä–∏–æ–±—Ä–µ–ª –≤–∞—à –∞–∫–∫–∞—É–Ω—Ç.</p>
          <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ –µ–º—É –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å –¥–ª—è –≤—Ö–æ–¥–∞.</p>
        </div>
      `;
      } else if (currentUser === buyer) {
        messageElement.innerHTML = `
          <div class="notification_buyer">
            <p>–í—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–æ–±—Ä–µ–ª–∏ –∞–∫–∫–∞—É–Ω—Ç —É –ø—Ä–æ–¥–∞–≤—Ü–∞ <strong>${seller}</strong>.</p>
            <p>–û–∂–∏–¥–∞–π—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å –¥–ª—è –≤—Ö–æ–¥–∞.</p>
            <button class="confirm_purchase" onclick="confirmPurchase()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–∫—É–ø–∫—É</button>
          </div>
        `;
   }
   chatMessages.appendChild(messageElement);
   chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  if (type === 'buy_account_acept') {
    const seller = "{{ chat_room.seller.username }}";
    const buyer = "{{ chat_room.buyer.username }}";
    const currentUser = "{{ user.username }}";
    const chatMessages = document.querySelector(".chat-log");
    const messageElement = document.createElement('div');
    messageElement.classList.add("buy_notification");
    console.log(444, currentUser, buyer, seller)

    if (currentUser === seller) {
      messageElement.innerHTML = `
      <div class="notification_seller">
        <p>–ü–æ–∫—É–ø–∞—Ç–µ–ª—å <strong>${buyer}</strong> –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –ø–æ–∫—É–ø–∫—É, –≤–∞—à –±–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω.</p>
      </div>
    `;
    } else if (currentUser === buyer) {
      const button = document.querySelector('.confirm_purchase');
      button.style.display = 'none'
      messageElement.innerHTML = `
        <div class="notification_buyer">
          <p>–í—ã —É—Å–ø–µ—à–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª–∏ –ø–æ–∫—É–ø–∫—É!</p>
        </div>
      `;
  }
  chatMessages.appendChild(messageElement);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}
};

function confirmPurchase() {
  chatSocket.send(JSON.stringify({
      'type': 'buy_account_acept',
  }));
};




  // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —á–∞—Ç –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  function scrollToBottom() {
    const chatMessages = document.querySelector(".chat-log");
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  scrollToBottom();

  document.querySelector('#chat-message-submit').onclick = function() {
      const messageInput = document.querySelector('#chat-message-input');
      const message = messageInput.value;
      console.log('Sending message:', message);

      chatSocket.send(JSON.stringify({
          'type': 'chat_message',
          'message': message,
          'sender_id': userId
      }));

      messageInput.value = '';
  };

  document.getElementById('bybtn').onclick = function() {
    chatSocket.send(JSON.stringify({
        'type': 'buy_account',
    }));
};


  let currentImageIndex = 0;
  let images = [];

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
  function openModal(imageUrl) {
    const modal = document.getElementById("imageModal");
    const modalImage = document.getElementById("modalImage");

    images = Array.from(document.querySelectorAll('.thumbnail')).map(img => img.src);
    currentImageIndex = images.indexOf(imageUrl);

    modal.style.display = "block";
    modalImage.src = imageUrl;
  }

  // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ Enter
document.querySelector('#chat-message-input').addEventListener('keydown', function(event) {
  if (event.key === 'Enter' && !event.shiftKey) {  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–∂–∞—Ç–∏—è Enter –±–µ–∑ Shift
      event.preventDefault();  // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏
      const messageInput = document.querySelector('#chat-message-input');
      const message = messageInput.value.trim();

      if (message === '') return;  // –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ø—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ

      console.log('Sending message:', message);

      chatSocket.send(JSON.stringify({
          'message': message,
          'sender_id': userId,
          'type': 'chat_message'
      }));

      messageInput.value = '';  // –û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ –≤–≤–æ–¥–∞ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
  }
});
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
  function closeModal() {
    document.getElementById("imageModal").style.display = "none";
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–º–µ–Ω—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
  function changeImage(direction) {
    currentImageIndex += direction;
    if (currentImageIndex < 0) {
      currentImageIndex = images.length - 1; // –ü–µ—Ä–µ—Ö–æ–¥ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é
    } else if (currentImageIndex >= images.length) {
      currentImageIndex = 0; // –ü–µ—Ä–µ—Ö–æ–¥ –∫ –ø–µ—Ä–≤–æ–º—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é
    }
    document.getElementById("modalImage").src = images[currentImageIndex];
  }


</script>
{% endblock %}
