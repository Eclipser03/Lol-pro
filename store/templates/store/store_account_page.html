{% extends "user/base.html" %}
{% load static %}
{% block head %}
  <link rel="stylesheet" href="{% static 'css/store_account_page.css' %}">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;700&display=swap" rel="stylesheet">
{% endblock %}
{% block content %}
<div class="container">
  <!-- Left Section: Order Information -->
  <div class="order-info">
    <div class="order-details">
      <h1>üõí –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞. –¶–µ–Ω–∞ –∞–∫–∫–∞—É–Ω—Ç–∞: {{ account.price }} —Ä—É–±.</h1>
      <p><span class="icon">‚úîÔ∏è</span>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞</p>
    </div>

    <!-- Table with order details -->
    <table class="order-table">
      <tr>
        <th>–°–µ—Ä–≤–µ—Ä:</th>
        <td>{{ account.server }}</td>
        <th>–ß–µ–º–ø–∏–æ–Ω—ã:</th>
        <td>{{ account.champions }}</td>
      </tr>
      <tr>
        <th>–£—Ä–æ–≤–µ–Ω—å:</th>
        <td>{{ account.lvl }}</td>
        <th>–†–∞–Ω–≥:</th>
        <td>{{ account.rang }}</td>
      </tr>
      <tr>
        <th>–°–∫–∏–Ω—ã:</th>
        <td>{{ account.skins }}</td>
      </tr>
    </table>

    <!-- Short description -->
    <div class="description">
      <h3>–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:</h3>
      <p>{{ account.short_description }}</p>
    </div>

    <!-- Long description -->
    <div class="long-description">
      <h3>–ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:</h3>
      <p>{{ account.description|linebreaksbr }}</p> <!-- –£–±—Ä–∞–ª–∏ –ª–∏—à–Ω—é—é —Å–∫–æ–±–∫—É -->
    </div>

    <div class="image-gallery">
      {% if account.images %}
        {% for image in account.images.all %}
        <div class="image-item">
          <img src="{{ image.image.url }}" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞" class="thumbnail" onclick="openModal('{{ image.image.url }}')">
          {% if account.user == request.user %}
          <button class="delete-btn" data-image-id="{{ image.id }}" onclick="deleteImage(event)">–£–¥–∞–ª–∏—Ç—å</button>
          {% endif %}
        </div>
        {% endfor %}
      {% endif %}
    </div>

      {% if account.is_active and account.user != request.user %}
      <div class="payment">
        <button type="submit" id="bybtn" class="btn">–ö—É–ø–∏—Ç—å</button>
      </div>
      {% endif %}

      {% if account.user == request.user and account.is_active %}
      <div class="settings">
        <button type="submit" id="btnset" class="btnset">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>
      {% endif %}

      {% if account.user == request.user and account.is_active %}
      <!-- <form action="{% url 'store:store_account_page' account.id %}" method="POST">
        {% csrf_token %} -->
        <div class="settings">
          <button name="delete_account" id="deleteaccount" class="btndeleteaccount">–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
        </div>
      <!-- </form> -->

      {% endif %}

  </div>

  <!-- Right Section: Seller Information -->
   {% if chat_room %}
  <div class="seller-info">
    <div class="info_seller">
      <img src="{{ account.user.avatar.url }}" alt="" class="avatar1">
      <div class="text-block">
        <h2>–ü—Ä–æ–¥–∞–≤–µ—Ü: {{ account.user.username }}</h2>
        <p class="status {% if account.user.is_online %}online{% else %}offline{% endif %}">{% if account.user.is_online %} –û–Ω–ª–∞–π–Ω {% else %} –û—Ñ—Ñ–ª–∞–π–Ω {% endif %}</p>
      </div>
    </div>
    <div class="chat-log">
      {% for sms in chat_room.messages.all %}
      {% if sms.massage_type == 'chat_message'%}
        {% if sms.author == user %}
          <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–≤—ã) -->
          <div class="message_you">
            <p>
              <span class="sender">–í—ã</span>: {{ sms.text }}</p>
              <p><span class="time">{{ sms.created|date:"H:i" }}</span></p>

          </div>
        {% else %}
          <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–æ–¥–∞–≤—Ü–∞) -->
          <div class="message_seller">
            <p>
              <span class="sender">{{ sms.author.username }}</span>: {{ sms.text }}</p>
              <p><span class="time">{{ sms.created|date:"H:i" }}</span></p>

          </div>
        {% endif %}
      {% endif %}
      {% if sms.massage_type == 'buy_account'%}
        {% if sms.author == user %}
        <div class="buy_notification">
          <div class="notification_buyer">
            <p>–í—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–æ–±—Ä–µ–ª–∏ –∞–∫–∫–∞—É–Ω—Ç —É –ø—Ä–æ–¥–∞–≤—Ü–∞ <strong>{{ chat_room.seller.username }}</strong>.</p>
            <p>–û–∂–∏–¥–∞–π—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å –¥–ª—è –≤—Ö–æ–¥–∞.</p>
            {% if account.buyer == user and not account.is_confirmed %}
              <button class="confirm_purchase" onclick="confirmPurchase()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–∫—É–ø–∫—É</button>
            {% endif %}
          </div>
        </div>
        {% else %}
        <div class="buy_notification">
          <div class="notification_seller">
            <p>–ü–æ–∫—É–ø–∞—Ç–µ–ª—å <strong>{{ chat_room.buyer.username }}</strong> –ø—Ä–∏–æ–±—Ä–µ–ª –≤–∞—à –∞–∫–∫–∞—É–Ω—Ç.</p>
            <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ –µ–º—É –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å –¥–ª—è –≤—Ö–æ–¥–∞.</p>
          </div>
        </div>
        {% endif %}
      {% endif %}
      {% if sms.massage_type == 'buy_account_acept'%}
          {% if sms.author == user %}
          <div class="buy_notification">
            <div class="notification_buyer">
              <p>–í—ã —É—Å–ø–µ—à–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª–∏ –ø–æ–∫—É–ø–∫—É!</p>
            </div>
          </div>
          {% else %}
          <div class="buy_notification">
            <div class="notification_seller">
              <p>–ü–æ–∫—É–ø–∞—Ç–µ–ª—å <strong>{{ chat_room.buyer.username }}</strong> –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –ø–æ–∫—É–ø–∫—É, –≤–∞—à –±–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω.</p>
            </div>
          </div>
          {% endif %}
      {% endif %}
      {% if sms.massage_type == 'buy_account_cancel'%}
          {% if sms.author == user %}
          <div class="buy_notification">
            <div class="notification_buyer">
              <p>–í—ã —É—Å–ø–µ—à–Ω–æ –æ—Ç–º–µ–Ω–∏–ª–∏ –∑–∞–∫–∞–∑.</p>
            </div>
          </div>
          {% else %}
          <div class="buy_notification">
            <div class="notification_seller">
              <p>–ü—Ä–æ–¥–∞–≤–µ—Ü –æ—Ç–º–µ–Ω–∏–ª –∑–∞–∫–∞–∑.</p>
            </div>
          </div>
          {% endif %}
      {% endif %}
      {% endfor %}
    </div>
    <input type="text" id="chat-message-input" autocomplete="off" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
    <button id="chat-message-submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </div>
  {% else %}
  {% endif %}
</div>
<div class="container1">
  <h1 class="">–û—Ç–∑—ã–≤—ã –æ –ø—Ä–æ–¥–∞–≤—Ü–µ</h1>
  <div class="container_reviews">
    <div class="read_reviews">
      {% for review in reviews %}
      <div class="review-container" data-review-id="{{ review.id }}">
        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –æ—Ç–∑—ã–≤ -->
        <div class="review">
          <div class="review-header">
            <div class="review-author-info">
            <img src="{{ review.buyer.avatar.url }}" alt="Avatar" class="review-avatar">
            <span class="review-author">{{ review.buyer.username }}</span>
            </div>
            <div>
              <span class="review-date">{{ review.created_at }}</span>
            </div>
          </div>
          <div class="review-stars" data-stars="{{ review.stars }}"></div>
          <p class="review-text">{{ review.reviews }}</p>
          {% if review.seller == request.user %}
          <button class="reply-button" onclick="toggleReplyForm(this)">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
          {% endif %}
        </div>

        <!-- –§–æ—Ä–º–∞ –¥–ª—è –æ—Ç–≤–µ—Ç–∞ -->

            <div class="reply-form" style="display: none;">
              <form action="{% url 'store:store_account_page' account.id %}" method="POST">
                {% csrf_token %}
                {{ form.reviews }}
                {{ form.parent }}

              <button type="submit" class="submit-reply">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
              </form>
            </div>


        {% if review.children.exists %}
        <!-- –í–ª–æ–∂–µ–Ω–Ω—ã–µ –æ—Ç–∑—ã–≤—ã -->
        <div class="nested-reviews">
          <!-- –ü—Ä–∏–º–µ—Ä –≤–ª–æ–∂–µ–Ω–Ω–æ–≥–æ –æ—Ç–∑—ã–≤–∞ -->
          <div class="review">
            {% for child in review.children.all|dictsort:"created_at" %}
            <div class="review-header">
              <div class="review-author-info">
              <img src="{{ child.seller.avatar.url }}" alt="Avatar" class="review-avatar">
              <span class="review-author">{{ child.user.username }}</span>
              </div>
              <div><span class="review-date">{{ child.created_at }}</span></div>
            </div>
            <p class="review-text">{{ child.reviews }}</p>
            {% endfor %}
          </div>
        </div>
        {% endif %}
      </div>
      {% endfor %}
    </div>

    <div class="pagination">
      {% if current_page.has_previous %}
        <a class="first" href="?page=1"><<</a>
        <a class="prev1" href="?page={{ current_page.previous_page_number }}">–ü—Ä–µ–¥—ã–¥—É—â–∞—è</a>
      {% endif %}

        <span class="pagination-info">–°—Ç—Ä–∞–Ω–∏—Ü–∞ <span id="current-page">{{ current_page.number }}</span> –∏–∑ <span id="total-pages">{{ paginator.num_pages }}</span></span>

      {% if current_page.has_next %}
        <a class="next1" href="?page={{ current_page.next_page_number }}">–°–ª–µ–¥—É—é—â–∞—è</a>
      {% endif %}
</div>


    {% if account.user != request.user and user.id not in user_list %}
    <div class="write_reviews">
      <div class="feedback-container">
        <h2>–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</h2>
        <h2>{{ account. }}</h2>

        <form action="{% url 'store:store_account_page' account.id %}" method="POST" class="feedback-form">
          {% csrf_token %}
          <!-- <label for="feedback-text">–í–∞—à –æ—Ç–∑—ã–≤:</label> -->
          {{ form.reviews }}
          <!-- <textarea id="feedback-text" name="feedback" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–≤–æ–π –æ—Ç–∑—ã–≤ –∑–¥–µ—Å—å..." required></textarea> -->

          <div class="star-rating">
            {{ form.stars }}
            <div class="stars">
              <span class="star" data-value="1">‚òÖ</span>
              <span class="star" data-value="2">‚òÖ</span>
              <span class="star" data-value="3">‚òÖ</span>
              <span class="star" data-value="4">‚òÖ</span>
              <span class="star" data-value="5">‚òÖ</span>
            </div>
          </div>

          <button name="reviewsbt" type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</button>
        </form>
      </div>
    </div>
    {% endif %}
  </div>
</div>
<!-- Modal for viewing large image -->
<div id="imageModal" class="modal">
  <span class="close" onclick="closeModal()">&times;</span>
  <img class="modal-content" id="modalImage">
  <a class="prev" onclick="changeImage(-1)">&#10094;</a>
  <a class="next" onclick="changeImage(1)">&#10095;</a>
</div>


  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞ -->
  <div class="form_set_account">
    <div class="form_setaccount">
      <h2>–î–æ–±–∞–≤–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</h2>
      <form action="{% url 'store:store_account_page' account.id %}" method='post' enctype="multipart/form-data">
        {% csrf_token %}
        <div class="inputs">
          <label>–°–µ—Ä–≤–µ—Ä:</label>
          {{ set_form.server }}
          <label>–£—Ä–æ–≤–µ–Ω—å –∞–∫–∫–∞—É–Ω—Ç–∞:</label>
          {{ set_form.lvl }}
          <label>–ö–æ–ª-–≤–æ —á–µ–º–ø–∏–æ–Ω–æ–≤:</label>
          {{ set_form.champions }}
          <label>–ö–æ–ª-–≤–æ —Å–∫–∏–Ω–æ–≤:</label>
          {{ set_form.skins }}
          <label>–†–∞–Ω–≥:</label>
          {{ set_form.rang }}
          <label>–ö–æ—Ä–æ—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:</label>
          {{ set_form.short_description }}
          <label>–ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:</label>
          {{ set_form.description }}
          <label>–¶–µ–Ω–∞:</label>
          {{ set_form.price }}
          <label>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: (–¥–æ 10 —à—Ç.)</label>
          <div class="file-upload-wrapper">
            <input type="file" id="file-input" name="images" multiple>
            <label for="file-input" class="custom-file-label">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã</label>
            <div id="file-list"></div>
        </div>
          <!-- {{image_form.image}} -->
        </div>
        <div style="margin: 0 auto;width: 200px; width: min-content;">
          <button class="savebtn" name="setting" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
          <!-- <input class="login_submit" type="submit" value="–î–æ–±–∞–≤–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç"> -->
        </div>
      </form>
    </div>
  </div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞ -->
  <div class="form_delete_account">
    <div class="form_deleteaccount">
      <h2>–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç?</h2>
        <form action="{% url 'store:store_account_page' account.id %}" method="POST">
        {% csrf_token %}
          <div class="settingsdelete">
            <button type="submit" name="delete_account" id="deleteaccount" class="btndeleteacept">–î–∞</button>
            <button name="close" id="close" class="btndelclose">–ù–µ—Ç</button>
          </div>
        </form>
        </div>
      </form>
    </div>
  </div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
  <div id="customModal" class="form_delete_image">
    <div class="form_deleteimage">
      <h2>–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ?</h2>
        {% csrf_token %}
          <div class="settingsdeleteimage">
            <button id="confirmYes" class="btn-yes">–î–∞</button>
            <button id="confirmNo" class="btn-no">–ù–µ—Ç</button>
          </div>
        </div>
    </div>
  </div>
{% endblock %}
{% block scripts %}
<script>

const deleteAccounBtn = document.getElementById("deleteaccount");
const formDeleteAccount = document.querySelector(".form_delete_account");
const form2 = document.querySelector(".form_deleteaccount");
const close = document.querySelector(".btndelclose");
// –û—Ç–∫—Ä—ã—Ç–∏–µ –∏ –∑–∞–∫—Ä—ã—Ç–∏–µ —Ñ–æ—Ä–º—ã –ø–æ –∫–Ω–æ–ø–∫–µ
deleteAccounBtn.addEventListener("click", function(event) {
  event.stopPropagation(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–±—ã—Ç–∏–µ, —á—Ç–æ–±—ã –∫–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–ª —Ñ–æ—Ä–º—É
  formDeleteAccount.style.display = formDeleteAccount.style.display === "block" ? "none" : "block";
});
// –ó–∞–∫—Ä—ã—Ç–∏–µ —Ñ–æ—Ä–º—ã –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–µ
document.addEventListener("click", function(event) {
  if (formDeleteAccount.style.display === "block") {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ –∫–ª–∏–∫ –≤–Ω–µ —Ñ–æ—Ä–º—ã
    if (!form2.contains(event.target) && event.target !== deleteAccounBtn) {
      formDeleteAccount.style.display = "none"; // –°–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
    }
  }

  close.addEventListener("click", function() {
    formDeleteAccount.style.display = "none";
  });
});


// –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
function showCustomModal(onConfirm) {
  const modal = document.getElementById("customModal");
  const confirmYes = document.getElementById("confirmYes");
  const confirmNo = document.getElementById("confirmNo");

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
  modal.style.display = "flex";

  // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–î–∞"
  confirmYes.onclick = function () {
    modal.style.display = "none"; // –°–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    onConfirm(true); // –í—ã–∑—ã–≤–∞–µ–º –∫–æ–ª–±—ç–∫ —Å true
  };

  // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–ù–µ—Ç"
  confirmNo.onclick = function () {
    modal.style.display = "none"; // –°–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    onConfirm(false); // –í—ã–∑—ã–≤–∞–µ–º –∫–æ–ª–±—ç–∫ —Å false
  };
}


function deleteImage(event) {
  event.preventDefault();

  const imageId = event.target.getAttribute("data-image-id"); // –ü–æ–ª—É—á–∞–µ–º ID –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
  const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value; // CSRF —Ç–æ–∫–µ–Ω –∏–∑ —Ñ–æ—Ä–º—ã
  console.log('TAK TAK', imageId)

  showCustomModal(function(isConfirmed) {
    if (isConfirmed) {
      fetch(`/delete-image/${imageId}/`, {
          method: "DELETE",
          headers: {
              "X-CSRFToken": csrfToken,
          }
      })
      .then(response => {
          if (response.ok) {
              event.target.parentElement.remove(); // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –∏–∑ DOM
              const messageDiv = document.createElement('div');
              messageDiv.className = 'alert alert-success'; // alert-info –∏–ª–∏ –¥—Ä—É–≥–æ–π –∫–ª–∞—Å—Å –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏
              messageDiv.textContent = '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ';

              // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
              const messagesContainer = document.getElementById('messages-container');
              messagesContainer.appendChild(messageDiv);

              // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
              setTimeout(() => {
                  messageDiv.style.opacity = '0';
                  messageDiv.style.transform = 'translateX(30px)';
                  setTimeout(() => messageDiv.remove(), 500);
              }, 5000);
          } else {
              const messageDiv = document.createElement('div');
              messageDiv.className = 'alert alert-warning'; // alert-info –∏–ª–∏ –¥—Ä—É–≥–æ–π –∫–ª–∞—Å—Å –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏
              messageDiv.textContent = '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è';

              // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
              const messagesContainer = document.getElementById('messages-container');
              messagesContainer.appendChild(messageDiv);

              // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
              setTimeout(() => {
                  messageDiv.style.opacity = '0';
                  messageDiv.style.transform = 'translateX(30px)';
                  setTimeout(() => messageDiv.remove(), 500);
              }, 5000);
          }
      })
      .catch(error => {
          console.error("–û—à–∏–±–∫–∞:", error);
          alert("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É.");
      });
  }
});
}




  let chatRoomId = "{{ chat_room.id }}";  // –ü–æ–¥—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π ID
  let accountId = "{{ account.id }}"
  let userId = "{{ request.user }}";   // –ü–æ–¥—Å—Ç–∞–≤–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  if (chatRoomId) {
  const wsUrl6 = 'ws://' + window.location.host + '/ws/chat/' + chatRoomId + '/' + accountId + '/';
  const byBtn = document.getElementById('bybtn');


  // –°–æ–∑–¥–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ WebSocket
  let chatSocket = new WebSocket(wsUrl6);

  chatSocket.onopen = function() {
      console.log('WebSocket connection opened');
  };

  chatSocket.onclose = function(e) {
      console.log('WebSocket connection closed: ', e);
  };

  chatSocket.onerror = function(e) {
      console.log('WebSocket error: ', e);
  };

  chatSocket.onmessage = function(e) {
      const data = JSON.parse(e.data);
      console.log('Message received:', data);

      const type = data.type
    if (type === 'chat_message') {
        const message = data.message;
        const username = data.username;
        const created = data.created;


      const currentUser = "{{ user.username }}";

        console.log('123',data)
        const chatMessages = document.querySelector(".chat-log");
        const messageElement = document.createElement('div');

        if (username === currentUser) {
          messageElement.classList.add("message_you");
          messageElement.innerHTML = `<p><span class="sender">–í—ã</span>: ${message} <span class="time">${created}</span></p>`;
        } else {
          messageElement.classList.add("message_seller");
          messageElement.innerHTML = `<p><span class="sender">${username}</span>: ${message} <span class="time">${created}</span></p>`;
        }

        chatMessages.appendChild(messageElement);
        chatMessages.scrollTop = chatMessages.scrollHeight

  }
   if (type === 'error') {
        const messagesDiv = document.getElementById("messages-container");
        var message = document.createElement('div');
        message.setAttribute('class', 'alert alert-' + "warning");
        message.textContent = data.message
        messagesDiv.appendChild(message)
     // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –∑–∞–¥–∞–µ–º —Ç–∞–π–º–µ—Ä –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è
     messagesDiv.style.display = "block";
     setTimeout(() => {
       messagesDiv.style.opacity = "0"; // –ü–ª–∞–≤–Ω–æ–µ –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ
       setTimeout(() => {
         messagesDiv.style.display = "none";
         messagesDiv.style.opacity = "1"; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –¥–ª—è –±—É–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
       }, 500); // –í—Ä–µ–º—è –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è (–≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö)
     }, 3000);
   }
   if (type === 'buy_account') {
      console.log(data)
      const currentUser = "{{ user.username }}";
      const userId = data.userid
      const seller = "{{ chat_room.seller.username }}";
      const buyer = "{{ chat_room.buyer.username }}";
      const chatMessages = document.querySelector(".chat-log");
      const messageElement = document.createElement('div');
      messageElement.classList.add("buy_notification");
      console.log('1111', currentUser, seller, buyer)

      // –£–¥–∞–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–ö—É–ø–∏—Ç—å", –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
  const buyButton = document.getElementById('bybtn'); // –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ ID –∫–Ω–æ–ø–∫–∏ "–ö—É–ø–∏—Ç—å"
  if (buyButton) {
    buyButton.remove();
  }

      if (currentUser === seller) {
        messageElement.innerHTML = `
        <div class="notification_seller">
          <p>–ü–æ–∫—É–ø–∞—Ç–µ–ª—å <strong>${buyer}</strong> –ø—Ä–∏–æ–±—Ä–µ–ª –≤–∞—à –∞–∫–∫–∞—É–Ω—Ç.</p>
          <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ –µ–º—É –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å –¥–ª—è –≤—Ö–æ–¥–∞.</p>
        </div>
      `;
      } else if (currentUser === buyer) {
        messageElement.innerHTML = `
          <div class="notification_buyer">
            <p>–í—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–æ–±—Ä–µ–ª–∏ –∞–∫–∫–∞—É–Ω—Ç —É –ø—Ä–æ–¥–∞–≤—Ü–∞ <strong>${seller}</strong>.</p>
            <p>–û–∂–∏–¥–∞–π—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å –¥–ª—è –≤—Ö–æ–¥–∞.</p>
            <button class="confirm_purchase" onclick="confirmPurchase()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–∫—É–ø–∫—É</button>
          </div>
        `;
   }
   chatMessages.appendChild(messageElement);
   chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  if (type === 'buy_account_acept') {
    const seller = "{{ chat_room.seller.username }}";
    const buyer = "{{ chat_room.buyer.username }}";
    const currentUser = "{{ user.username }}";
    const chatMessages = document.querySelector(".chat-log");
    const messageElement = document.createElement('div');
    messageElement.classList.add("buy_notification");
    console.log(444, currentUser, buyer, seller)

    if (currentUser === seller) {
      messageElement.innerHTML = `
      <div class="notification_seller">
        <p>–ü–æ–∫—É–ø–∞—Ç–µ–ª—å <strong>${buyer}</strong> –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –ø–æ–∫—É–ø–∫—É, –≤–∞—à –±–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω.</p>
      </div>
    `;
    } else if (currentUser === buyer) {
      const button = document.querySelector('.confirm_purchase');
      button.style.display = 'none'
      messageElement.innerHTML = `
        <div class="notification_buyer">
          <p>–í—ã —É—Å–ø–µ—à–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª–∏ –ø–æ–∫—É–ø–∫—É!</p>
        </div>
      `;
  }
  chatMessages.appendChild(messageElement);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

  if (type === 'buy_account_cancel') {
    const seller = "{{ chat_room.seller.username }}";
    const buyer = "{{ chat_room.buyer.username }}";
    const currentUser = "{{ user.username }}";
    const chatMessages = document.querySelector(".chat-log");
    const messageElement = document.createElement('div');
    messageElement.classList.add("buy_notification");
    console.log(444, currentUser, buyer, seller)

    if (currentUser === seller) {
      messageElement.innerHTML = `
      <div class="notification_buyernotification_seller">
        <p>–í—ã —É—Å–ø–µ—à–Ω–æ –æ—Ç–º–µ–Ω–∏–ª–∏ –∑–∞–∫–∞–∑</p>
      </div>
    `;
    } else if (currentUser === buyer) {
      const button = document.querySelector('.confirm_purchase');
      button.style.display = 'none'
      messageElement.innerHTML = `
        <div class="notification_seller">
          <p>–ü—Ä–æ–¥–∞–≤–µ—Ü –æ—Ç–º–µ–Ω–∏–ª –∑–∞–∫–∞–∑.</p>
        </div>
      `;
  }
  chatMessages.appendChild(messageElement);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}
};

function confirmPurchase() {
  chatSocket.send(JSON.stringify({
      'type': 'buy_account_acept',
  }));
};


// –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —á–∞—Ç –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
function scrollToBottom() {
  const chatMessages = document.querySelector(".chat-log");
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

scrollToBottom();

document.querySelector('#chat-message-submit').onclick = function() {
    const messageInput = document.querySelector('#chat-message-input');
    const message = messageInput.value;
    console.log('Sending message:', message);

    chatSocket.send(JSON.stringify({
        'type': 'chat_message',
        'message': message,
        'sender_id': userId
    }));

    messageInput.value = '';
};

const currentBalance = parseFloat('{{ user.balance }}')
const accountPrice = parseFloat('{{ account.price }}');

document.getElementById('bybtn').onclick = function() {
  if (currentBalance < accountPrice) {
    // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
    const messageDiv = document.createElement('div');
    messageDiv.className = 'alert alert-warning'; // –ö–ª–∞—Å—Å –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏
    messageDiv.textContent = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å'; // –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ

    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    const messagesContainer = document.getElementById('messages-container');
    messagesContainer.appendChild(messageDiv);

    // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
        messageDiv.style.opacity = '0';
        messageDiv.style.transform = 'translateX(30px)';
        setTimeout(() => messageDiv.remove(), 500); // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
    }, 5000);

    return; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
}


  chatSocket.send(JSON.stringify({
      'type': 'buy_account',
  }));
};

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ Enter
document.querySelector('#chat-message-input').addEventListener('keydown', function(event) {
  if (event.key === 'Enter' && !event.shiftKey) {  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–∂–∞—Ç–∏—è Enter –±–µ–∑ Shift
      event.preventDefault();  // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏
      const messageInput = document.querySelector('#chat-message-input');
      const message = messageInput.value.trim();

      if (message === '') return;  // –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ø—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ

      console.log('Sending message:', message);

      chatSocket.send(JSON.stringify({
          'message': message,
          'sender_id': userId,
          'type': 'chat_message'
      }));

      messageInput.value = '';  // –û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ –≤–≤–æ–¥–∞ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
  }
});


}


const notificationSocket = new WebSocket('ws://' + window.location.host + '/ws/notification/');

notificationSocket.onmessage = function(event) {
  let chatRoomId = "{{ chat_room.id }}"
  const data = JSON.parse(event.data);
  const chatroom = data.chat_room
  console.log('DATA1', data)
  if (chatroom != chatRoomId && data.type === 'notification') {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'alert alert-success'; // alert-info –∏–ª–∏ –¥—Ä—É–≥–æ–π –∫–ª–∞—Å—Å –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏
    messageDiv.textContent = data.message;

    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    const messagesContainer = document.getElementById('messages-container');
    messagesContainer.appendChild(messageDiv);

    // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
        messageDiv.style.opacity = '0';
        messageDiv.style.transform = 'translateX(30px)';
        setTimeout(() => messageDiv.remove(), 500);
    }, 5000);
  }

}



  let currentImageIndex = 0;
  let images = [];

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
  function openModal(imageUrl) {
    const modal = document.getElementById("imageModal");
    const modalImage = document.getElementById("modalImage");

    images = Array.from(document.querySelectorAll('.thumbnail')).map(img => img.src);
    currentImageIndex = images.indexOf(imageUrl);

    modal.style.display = "block";
    modalImage.src = imageUrl;
  }


  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
  function closeModal() {
    document.getElementById("imageModal").style.display = "none";
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–º–µ–Ω—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
  function changeImage(direction) {
    currentImageIndex += direction;
    if (currentImageIndex < 0) {
      currentImageIndex = images.length - 1; // –ü–µ—Ä–µ—Ö–æ–¥ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é
    } else if (currentImageIndex >= images.length) {
      currentImageIndex = 0; // –ü–µ—Ä–µ—Ö–æ–¥ –∫ –ø–µ—Ä–≤–æ–º—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é
    }
    document.getElementById("modalImage").src = images[currentImageIndex];
  }


function toggleReplyForm(button) {
  const replyForm = button.parentElement.nextElementSibling;
  replyForm.style.display = replyForm.style.display === "none" ? "block" : "none";
  const reviewContainer = button.closest(".review-container");
  const reviewId = reviewContainer.getAttribute("data-review-id");
  let parent = replyForm.querySelector(".parent")
  parent.value = reviewId
  console.log(reviewId)
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–≤–µ–∑–¥ –≤ –æ—Ç–∑—ã–≤–µ
document.addEventListener("DOMContentLoaded", function () {
  const starContainers = document.querySelectorAll(".review-stars");

  starContainers.forEach(container => {
    const starCount = parseInt(container.getAttribute("data-stars")) || 0;

    // –°–æ–∑–¥–∞–µ–º 5 –∑–≤–µ–∑–¥
    for (let i = 1; i <= 5; i++) {
      const star = document.createElement("div");
      star.classList.add("star");
      if (i <= starCount) {
        star.classList.add("active");
      }
      container.appendChild(star);
    }
  });
});


document.addEventListener("DOMContentLoaded", function () {
  const stars = document.querySelectorAll(".stars .star");
  const ratingInput = document.querySelector(".star-input");
  const form = document.querySelector(".feedback-form");

  stars.forEach(star => {
    star.addEventListener("click", () => {
      const value = parseInt(star.getAttribute("data-value"));

      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ–π—Ç–∏–Ω–≥ –≤ —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ
      ratingInput.value = value;

      // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–≤–µ–∑–¥—ã
      stars.forEach(s => {
        s.classList.toggle("active", parseInt(s.getAttribute("data-value")) <= value);
      });
    });

    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
    star.addEventListener("mouseover", () => {
      const value = parseInt(star.getAttribute("data-value"));
      stars.forEach(s => {
        s.classList.toggle("active", parseInt(s.getAttribute("data-value")) <= value);
      });
    });

    // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –ø—Ä–∏ —É—Ö–æ–¥–µ –º—ã—à–∏
    star.addEventListener("mouseout", () => {
      const currentValue = parseInt(ratingInput.value) || 0;
      stars.forEach(s => {
        s.classList.toggle("active", parseInt(s.getAttribute("data-value")) <= currentValue);
      });
    });
  });

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤—ã–±–æ—Ä–∞ –∑–≤–µ–∑–¥ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Ñ–æ—Ä–º—ã
  form.addEventListener("submit", function (event) {
    if (!ratingInput.value) {
      alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–π—Ç–∏–Ω–≥.");
      event.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã
    }
  });
});



const addaccountBtn = document.getElementById("btnset");
const formAddAccount = document.querySelector(".form_set_account");
const form1 = document.querySelector(".form_setaccount");
// –û—Ç–∫—Ä—ã—Ç–∏–µ –∏ –∑–∞–∫—Ä—ã—Ç–∏–µ —Ñ–æ—Ä–º—ã –ø–æ –∫–Ω–æ–ø–∫–µ
addaccountBtn.addEventListener("click", function(event) {
  event.stopPropagation(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–±—ã—Ç–∏–µ, —á—Ç–æ–±—ã –∫–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–ª —Ñ–æ—Ä–º—É
  formAddAccount.style.display = formAddAccount.style.display === "block" ? "none" : "block";
});
// –ó–∞–∫—Ä—ã—Ç–∏–µ —Ñ–æ—Ä–º—ã –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–µ
document.addEventListener("click", function(event) {
  if (formAddAccount.style.display === "block") {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ –∫–ª–∏–∫ –≤–Ω–µ —Ñ–æ—Ä–º—ã
    if (!form1.contains(event.target) && event.target !== addaccountBtn) {
      formAddAccount.style.display = "none"; // –°–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
    }
  }
});

document.getElementById('file-input').addEventListener('change', function() {
  const fileList = document.getElementById('file-list');
  fileList.innerHTML = "";  // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤

  Array.from(this.files).forEach(file => {
      const listItem = document.createElement('div');
      listItem.textContent = file.name;
      fileList.appendChild(listItem);
  });
});



</script>
{% endblock %}
