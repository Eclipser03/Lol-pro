{% extends "user/base.html" %}
{% load static %}
{% block head %}
  <link rel="stylesheet" href="{% static 'css/store_account_page.css' %}">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;700&display=swap" rel="stylesheet">
{% endblock %}
{% block content %}
<div class="container">
  <!-- Left Section: Order Information -->
  <div class="order-info">
    <div class="order-details">
      <h1>üõí –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h1>
      <p><span class="icon">‚úîÔ∏è</span>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞</p>
    </div>

    <!-- Table with order details -->
    <table class="order-table">
      <tr>
        <th>–°–µ—Ä–≤–µ—Ä:</th>
        <td>{{ account.server }}</td>
        <th>–ß–µ–º–ø–∏–æ–Ω—ã:</th>
        <td>{{ account.champions }}</td>
      </tr>
      <tr>
        <th>–£—Ä–æ–≤–µ–Ω—å:</th>
        <td>{{ account.lvl }}</td>
        <th>–†–∞–Ω–≥:</th>
        <td>{{ account.rang }}</td>
      </tr>
      <tr>
        <th>–°–∫–∏–Ω—ã:</th>
        <td>{{ account.skins }}</td>
      </tr>
    </table>

    <!-- Short description -->
    <div class="description">
      <h3>–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:</h3>
      <p>{{ account.short_description }}</p>
    </div>

    <!-- Long description -->
    <div class="long-description">
      <h3>–ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:</h3>
      <p>{{ account.description|linebreaksbr }}</p> <!-- –£–±—Ä–∞–ª–∏ –ª–∏—à–Ω—é—é —Å–∫–æ–±–∫—É -->
    </div>

    <div class="image-gallery">
      {% if account.images %}
        {% for image in account.images.all %}
          <img src="{{ image.image.url }}" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞" class="thumbnail" onclick="openModal('{{ image.image.url }}')">
        {% endfor %}
      {% endif %}
    </div>

    <!-- Payment section -->
    <div class="payment">
      <p class="price">{{ account.price }} —Ä—É–±.</p>
      <a href="#" class="btn">–ö—É–ø–∏—Ç—å</a>
    </div>
  </div>

  <!-- Right Section: Seller Information -->
   {% if chat_room %}
  <div class="seller-info">
    <h2>–ü—Ä–æ–¥–∞–≤–µ—Ü: {{ account.user.username }}</h2>
    <h1>–ß–∞—Ç —Å –ø—Ä–æ–¥–∞–≤—Ü–æ–º</h1>
    <div id="chat-log"></div>
    <input type="text" id="chat-message-input" autocomplete="off" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
    <button id="chat-message-submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </div>
  {% else %}
  {% endif %}
</div>

<!-- Modal for viewing large image -->
<div id="imageModal" class="modal">
  <span class="close" onclick="closeModal()">&times;</span>
  <img class="modal-content" id="modalImage">
  <a class="prev" onclick="changeImage(-1)">&#10094;</a>
  <a class="next" onclick="changeImage(1)">&#10095;</a>
</div>
{% endblock %}
{% block scripts %}
<script>
  let chatRoomId = "{{ chat_room.id }}";  // –ü–æ–¥—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π ID
  let userId = "{{ request.user.id }}";   // –ü–æ–¥—Å—Ç–∞–≤–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  const wsUrl = 'ws://' + window.location.host + '/ws/chat/' + chatRoomId + '/';
  console.log("WebSocket URL for user:", wsUrl);

  // –°–æ–∑–¥–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ WebSocket
  let chatSocket = new WebSocket(wsUrl);

  chatSocket.onopen = function() {
      console.log('WebSocket connection opened');
  };

  chatSocket.onclose = function(e) {
      console.log('WebSocket connection closed: ', e);
  };

  chatSocket.onerror = function(e) {
      console.log('WebSocket error: ', e);
  };

  chatSocket.onmessage = function(e) {
      const data = JSON.parse(e.data);
      console.log('Message received:', data);

      const message = data.message;
      const senderId = data.sender_id;

      const messageElement = document.createElement('div');
      messageElement.textContent = (senderId == userId ? "–í—ã: " : "–ü—Ä–æ–¥–∞–≤–µ—Ü: ") + message;
      document.querySelector('#chat-log').appendChild(messageElement);
  };

  document.querySelector('#chat-message-submit').onclick = function() {
      const messageInput = document.querySelector('#chat-message-input');
      const message = messageInput.value;
      console.log('Sending message:', message);

      chatSocket.send(JSON.stringify({
          'message': message,
          'sender_id': userId
      }));

      messageInput.value = '';
  };

  let currentImageIndex = 0;
  let images = [];

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
  function openModal(imageUrl) {
    const modal = document.getElementById("imageModal");
    const modalImage = document.getElementById("modalImage");

    images = Array.from(document.querySelectorAll('.thumbnail')).map(img => img.src);
    currentImageIndex = images.indexOf(imageUrl);

    modal.style.display = "block";
    modalImage.src = imageUrl;
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
  function closeModal() {
    document.getElementById("imageModal").style.display = "none";
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–º–µ–Ω—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
  function changeImage(direction) {
    currentImageIndex += direction;
    if (currentImageIndex < 0) {
      currentImageIndex = images.length - 1; // –ü–µ—Ä–µ—Ö–æ–¥ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é
    } else if (currentImageIndex >= images.length) {
      currentImageIndex = 0; // –ü–µ—Ä–µ—Ö–æ–¥ –∫ –ø–µ—Ä–≤–æ–º—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é
    }
    document.getElementById("modalImage").src = images[currentImageIndex];
  }
</script>
{% endblock %}
